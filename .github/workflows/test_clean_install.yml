name: test clean install on MacOS

on: push

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-clean-install:
    runs-on: macos-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: setup
        run: sh ${GITHUB_WORKSPACE}/initial_setup.sh

      - name: link dotfiles
        # restart should reload `.zshrc`
        run: |
          DOTFILES_DIR=${GITHUB_WORKSPACE} sh ${GITHUB_WORKSPACE}/scripts/link_dotfiles.sh
          restart

      - name: mise install
        run: mise install

      - name: check mise
        # mise doctor will fail
        continue-on-error: true
        run: |
          mise doctor
          mise list
          mise tasks

      - name: check homebrew
        run: brew list --formula
